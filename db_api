import pymysql
from constants import MYSQL_IP, MYSQL_USER, MYSQL_PASSWORD, MYSQL_BD_NAME


def connect_and_run(func):
    def wrap(*args):
        conn = pymysql.connect(host=MYSQL_IP,
                               database=MYSQL_BD_NAME,
                               user=MYSQL_USER,
                               password=MYSQL_PASSWORD)
        cursor = conn.cursor()
        result = func(*args, cursor)
        conn.commit()
        cursor.close()
        return result
    return wrap


@connect_and_run
def change_state(user_id, new_state, cursor):
    sql = '''INSERT INTO `users` (`user_id`, `state`) 
             VALUES (%s, %s)
             ON DUPLICATE KEY UPDATE  `state`=%s'''
    data = [user_id, new_state, new_state]
    cursor.execute(sql, data)


@connect_and_run
def get_state(user_id, cursor):
    sql = '''SELECT `state` 
             FROM `users` 
             WHERE `user_id`=%s'''
    cursor.execute(sql, user_id)
    return cursor.fetchall()[0][0]


@connect_and_run
def set_tracking(user_id, tracking_type, tracked_id, is_main, cursor):
    sql = '''INSERT INTO `trackings`
             VALUES (%s, %s, %s, %s)'''
    data = [user_id, tracking_type, tracked_id, is_main]
    cursor.execute(sql, data)


@connect_and_run
def reset_tracking(user_id, tracking_type, tracked_id, cursor):
    sql = '''DELETE FROM `trackings`
             WHERE `user_id` = %s
             AND `type` = %s
             AND `tracked_id` = %s'''
    data = [user_id, tracking_type, tracked_id]
    cursor.execute(sql,data)


@connect_and_run
def set_buffer(user_id, buffer, cursor):
    sql = '''UPDATE `users` 
             SET `buffer`=%s
             WHERE `user_id`=%s'''
    data = [user_id, buffer]
    cursor.execute(sql, data)


@connect_and_run
def get_buffer(user_id, cursor):
    sql = '''SELECT `buffer` 
                 FROM `users` 
                 WHERE `user_id`=%s'''
    cursor.execute(sql, user_id)
    return cursor.fetchall()[0][0]


@connect_and_run
def get_faculties(cursor):
    sql = '''SELECT `faculty_name_ru` 
             FROM `faculties`
             GROUP BY  `faculty_name_ru`'''
    cursor.execute(sql)
    return [faculty[0] for faculty in cursor.fetchall()]


@connect_and_run
def get_specialities(faculty, cursor):
    sql = '''SELECT `group_speciality_name` 
             FROM `groups` 
             JOIN `faculties` ON `groups`.`faculty_id`=`faculties`.`faculty_id`
             WHERE `faculties`.`faculty_name_ru` LIKE %s
             GROUP BY `group_speciality_name` 
             ORDER BY `group_speciality_name`'''
    cursor.execute(sql, faculty)
    return [speciality[0] for speciality in cursor.fetchall()]


@connect_and_run
def get_groups(speciality, cursor):
    sql = '''SELECT `group_number` 
             FROM `groups` 
             WHERE `group_speciality_name` LIKE %s
             ORDER BY `group_number`'''
    cursor.execute(sql, speciality)
    return [group[0] for group in cursor.fetchall()]


@connect_and_run
def get_teachers(name, cursor):
    sql = '''SELECT `surname_ru`, `first_name_ru`, `patronymic_ru`
             FROM `teachers`
             WHERE `surname_ru` LIKE %s 
             OR `first_name_ru` LIKE %s
             OR  `patronymic_ru` LIKE %s
             ORDER BY `surname_ru`, `first_name_ru`, `patronymic_ru`'''
    data = [f'%{name}%']*3
    cursor.execute(sql, data)
    return [' '.join(names) for names in cursor.fetchall()]


@connect_and_run
def get_buildings(cursor):
    sql = '''SELECT `building_ru` 
             FROM `rooms`
             GROUP BY  `building_ru`
             ORDER BY  `building_ru`'''
    cursor.execute(sql)
    return [building[0] for building in cursor.fetchall() if building[0] != '']


@connect_and_run
def get_rooms(number, building, cursor):
    sql = '''SELECT `number` 
             FROM `rooms` 
             WHERE `building_ru`=%s 
             AND `number` LIKE %s
             ORDER BY `number`'''
    data = [building, f'%{number}%']
    cursor.execute(sql, data)
    return [room[0] for room in cursor.fetchall()]


@connect_and_run
def get_teacher_id(name, cursor):
    sql = '''SELECT `teacher_id` 
                 FROM `teachers` 
                 WHERE `surname_ru` = %s 
                 AND `first_name_ru` = %s
                 AND `patronymic_ru` = %s'''
    data = name.split()
    cursor.execute(sql, data)
    return cursor.fetchall()[0][0]


@connect_and_run
def get_group_id(group, cursor):
    sql = '''SELECT `group_id` 
                 FROM `groups` 
                 WHERE `group_number` = %s'''
    cursor.execute(sql, group)
    return cursor.fetchall()[0][0]


@connect_and_run
def get_room_id(number, building, cursor):
    sql = '''SELECT `room_id` 
             FROM `rooms` 
             WHERE `building_ru`= %s 
             AND `number`= %s'''
    data = [building, number]
    cursor.execute(sql, data)
    return cursor.fetchall()[0][0]
